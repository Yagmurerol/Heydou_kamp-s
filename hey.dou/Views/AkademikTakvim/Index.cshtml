@model List<hey.dou.Models.AkademikTakvim>
@{
    ViewData["Title"] = "Akademik Takvim";

    int currentYear = (int)ViewBag.CurrentYear;
    int currentMonth = (int)ViewBag.CurrentMonth;

    var today = DateTime.Today;
    var firstDay = new DateTime(currentYear, currentMonth, 1);
    var daysInMonth = DateTime.DaysInMonth(currentYear, currentMonth);

    // pazartesiyle başlasın
    int padding = ((int)firstDay.DayOfWeek + 6) % 7;

    var monthEvents = Model ?? new List<hey.dou.Models.AkademikTakvim>();

    string MonthNameTr(int m)
    {
        string[] names = { "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık" };
        return names[m - 1];
    }

    string GetColor(hey.dou.Models.AkademikTakvim ev)
    {
        if (!string.IsNullOrWhiteSpace(ev.RenkKodu))
            return ev.RenkKodu;

        if (!string.IsNullOrWhiteSpace(ev.Kategori))
        {
            if (ev.Kategori.Contains("Sınav")) return "#f59e0b";
            if (ev.Kategori.Contains("Tatil")) return "#10b981";
            if (ev.Kategori.Contains("Kayıt")) return "#ef4444";
        }
        return "#94a3b8";
    }

    string prevUrl = Url.Action("Index", "AkademikTakvim", new { year = (int)ViewBag.PreviousYear, month = (int)ViewBag.PreviousMonth })!;
    string nextUrl = Url.Action("Index", "AkademikTakvim", new { year = (int)ViewBag.NextYear, month = (int)ViewBag.NextMonth })!;
}

<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-3xl md:text-4xl font-extrabold">Akademik Takvim</h2>
        <p class="text-sm text-slate-500 mt-1">Sınav, tatil ve kayıt dönemlerini buradan takip edebilirsin.</p>
    </div>

    <button type="button"
            onclick="window.print()"
            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 dark:border-slate-700 px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-800/40">
        <span class="material-symbols-rounded text-base">print</span>
        Yazdır
    </button>
</div>

<div class="flex flex-col lg:flex-row gap-6">
    <!-- SOL PANEL -->
    <aside class="w-full lg:w-1/4 xl:w-1/5 space-y-6">
        <div class="bg-white dark:bg-card-dark p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-sm font-semibold mb-3">Filtrele</p>
            <div class="space-y-2 text-sm">
                <label class="flex items-center gap-2">
                    <input type="radio" name="takvimFilter" value="ALL" checked />
                    <span>Tümü</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="takvimFilter" value="Sınav" />
                    <span>Sınavlar</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="takvimFilter" value="Tatil" />
                    <span>Tatiller</span>
                </label>
                <label class="flex items-center gap-2">
                    <input type="radio" name="takvimFilter" value="Kayıt" />
                    <span>Kayıt Dönemleri</span>
                </label>
            </div>
        </div>

        <div class="bg-white dark:bg-card-dark p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <p class="text-sm font-semibold mb-3">Renk Kodu</p>
            <ul class="space-y-2 text-sm">
                <li class="flex items-center gap-2">
                    <span class="h-3 w-3 rounded-full bg-[#f59e0b]"></span> Sınavlar
                </li>
                <li class="flex items-center gap-2">
                    <span class="h-3 w-3 rounded-full bg-[#10b981]"></span> Tatiller
                </li>
                <li class="flex items-center gap-2">
                    <span class="h-3 w-3 rounded-full bg-[#ef4444]"></span> Kayıt Dönemleri
                </li>
            </ul>
        </div>
    </aside>

    <!-- SAĞ TARAF -->
    <section class="flex-1 space-y-6">
        <!-- TAKVİM -->
        <div class="bg-white dark:bg-card-dark p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">
                    @MonthNameTr(currentMonth) @currentYear
                </h3>

                <div class="flex gap-2">
                    <a href="@prevUrl"
                       class="h-9 w-9 rounded-full bg-slate-100 dark:bg-slate-700/50 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700">
                        <span class="material-symbols-rounded text-sm">chevron_left</span>
                    </a>
                    <a href="@nextUrl"
                       class="h-9 w-9 rounded-full bg-slate-100 dark:bg-slate-700/50 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700">
                        <span class="material-symbols-rounded text-sm">chevron_right</span>
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-2 text-center text-xs font-semibold text-slate-400 mb-2">
                <div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div>
            </div>

            <div class="grid grid-cols-7 gap-2 text-center">
                @for (int i = 0; i < padding; i++)
                {
                    <div class="h-16 rounded-xl"></div>
                }

                @for (int day = 1; day <= daysInMonth; day++)
                {
                    var dayDate = new DateOnly(currentYear, currentMonth, day);

                    var eventsOfDay = monthEvents
                    .Where(e => e.BaslangicTarihi <= dayDate && e.BitisTarihi >= dayDate)
                    .ToList();

                    bool isToday = (day == today.Day && currentMonth == today.Month && currentYear == today.Year);

                    <button type="button"
                            data-date="@dayDate.ToString("yyyy-MM-dd")"
                            class="day-cell h-16 w-full rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50/40 dark:bg-slate-900/30 flex flex-col items-center py-1 gap-1 hover:bg-slate-100/60 dark:hover:bg-slate-800/40 transition @(isToday ? "ring-2 ring-orange-400" : "")">
                        <span class="text-sm font-semibold @(isToday ? "text-orange-600" : "text-slate-700 dark:text-slate-200")">
                            @day
                        </span>

                        <div class="flex gap-1 flex-wrap justify-center">
                            @foreach (var ev in eventsOfDay.Take(3))
                            {
                                var c = GetColor(ev);
                                <span class="h-2 w-2 rounded-full" style="background-color:@c"></span>
                            }
                        </div>
                    </button>
                }
            </div>
        </div>

        <!-- SEÇİLEN GÜN PANELİ -->
        <div class="bg-white dark:bg-card-dark rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 dark:border-slate-700">
                <p class="font-semibold text-sm">Seçilen Gün Etkinlikleri</p>
            </div>

            <div id="eventsPanel" class="p-6 space-y-3">
                <p class="text-sm text-slate-400">Bir gün seç.</p>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <script>
        const panel = document.getElementById("eventsPanel");
        const cells = document.querySelectorAll(".day-cell");
        const filterRadios = document.querySelectorAll("input[name='takvimFilter']");

        function setSelected(el) {
            cells.forEach(c => c.classList.remove("ring-2", "ring-orange-400"));
            el.classList.add("ring-2", "ring-orange-400");
        }

        function getSelectedFilter() {
            const checked = document.querySelector("input[name='takvimFilter']:checked");
            return checked ? checked.value : "ALL";
        }

        async function loadEvents(date, el) {
            try {
                if (el) setSelected(el);
                panel.innerHTML = "<p class='text-sm text-slate-400'>Yükleniyor...</p>";

                const res = await fetch(`/AkademikTakvim/GetEventsByDate?date=${encodeURIComponent(date)}`);
                let html = await res.text();

                const filter = getSelectedFilter();
                if (filter !== "ALL") {
                    const temp = document.createElement("div");
                    temp.innerHTML = html;

                    const items = [...temp.querySelectorAll("div.flex.items-start")];
                    items.forEach(item => {
                        const title = item.querySelector("p.font-semibold");
                        const text = title ? title.textContent : "";
                        if (!text.includes(filter)) item.remove();
                    });

                    html = temp.innerHTML.trim();
                    if (!html) html = "<p class='text-gray-400 text-sm'>Bu filtreye uygun etkinlik bulunamadı.</p>";
                }

                panel.innerHTML = html;
            } catch {
                panel.innerHTML = "<p class='text-red-500 text-sm'>Bir hata oluştu.</p>";
            }
        }

        cells.forEach(btn => btn.addEventListener("click", () => loadEvents(btn.dataset.date, btn)));

        filterRadios.forEach(r => {
            r.addEventListener("change", () => {
                const selected = document.querySelector(".day-cell.ring-2");
                if (selected) loadEvents(selected.dataset.date, selected);
            });
        });

        const todayStr = new Date().toISOString().slice(0, 10);
        const todayCell = [...cells].find(x => x.dataset.date === todayStr);
        if (todayCell) todayCell.click();
    </script>
}
