@model hey.dou.Models.Anket
@{
    ViewData["Title"] = "Etkinlik Anketi";
    bool hasVoted = ViewBag.HasVoted ?? false;

    var orderedOptions = Model.AnketSecenegis.OrderBy(s => s.SecenekId).ToList();
    int totalVotes = orderedOptions.Sum(s => s.Oys.Count);
    var winningOption = (totalVotes > 0) ? orderedOptions.OrderByDescending(s => s.Oys.Count).FirstOrDefault() : null;
}

<!-- ✅ Layout uyumlu: body yok -->
<div class="px-4 sm:px-10 lg:px-40 py-8">
    <!-- Başlık -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-black tracking-tight text-gray-900 dark:text-white">
            Etkinlik Anketi
        </h1>
        <p class="mt-2 text-gray-500 dark:text-gray-300">
            Aşağıdaki seçeneklerden birini oylayarak etkinliği belirleyin.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- SOL: Oy Kullan -->
        <div class="bg-white dark:bg-card-dark rounded-2xl border border-gray-100 dark:border-white/10 shadow-sm p-6">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white">Oyunu Kullan</h2>
                <span class="text-xs font-semibold px-3 py-1 rounded-full
                             @(Model.IsActive ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-200" : "bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200")">
                    @(Model.IsActive ? "Aktif" : "Kapalı")
                </span>
            </div>

            <form asp-action="Vote" method="post">
                <input type="hidden" name="anketID" value="@Model.AnketId" />

                <div class="flex flex-col gap-3">
                    @foreach (var secenek in orderedOptions)
                    {
                        <label class="group flex items-center gap-4 rounded-xl border border-gray-200 dark:border-white/10 p-4 cursor-pointer
                                          hover:border-primary/50 transition
                                          has-[:checked]:border-primary has-[:checked]:bg-primary/10 dark:has-[:checked]:bg-primary/15
                                          shadow-[0_0_0_rgba(0,0,0,0)] hover:shadow-[0_0_18px_rgba(222,125,125,0.18)]">

                            <input class="h-5 w-5 border-2 border-gray-300 dark:border-white/20 bg-transparent text-primary focus:ring-primary checked:border-primary checked:bg-primary"
                                   name="secenekID" value="@secenek.SecenekId" type="radio" required
                                   disabled="@(hasVoted || !Model.IsActive)" />

                            <div class="flex grow items-center justify-between gap-3">
                                <p class="text-gray-900 dark:text-white text-base font-medium">
                                    @secenek.SecenekText
                                </p>

                                <button type="button"
                                        class="js-info-btn text-gray-400 hover:text-primary transition p-2 rounded-full hover:bg-primary/10"
                                        data-title="@secenek.SecenekText"
                                        data-desc="@secenek.KisaAciklama"
                                        data-kulup="@secenek.KulupAdi"
                                        data-baskan="@secenek.KulupBaskaniAdi"
                                        data-konum="@secenek.Konum"
                                        data-tarih="@(secenek.TarihSaat.HasValue? secenek.TarihSaat.Value.ToString("dd MMMM HH:mm") : "")">
                                    <span class="material-symbols-outlined text-[22px]">info</span>
                                </button>
                            </div>
                        </label>
                    }
                </div>

                <div class="mt-5">
                    <button type="submit"
                            class="w-full h-12 rounded-xl bg-primary text-white font-bold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_10px_24px_rgba(222,125,125,0.22)]"
                            disabled="@(hasVoted || !Model.IsActive)">
                        @if (hasVoted)
                        {
                            <span>Oy Verdiniz</span>
                        }
                        else if (!Model.IsActive)
                        {
                            <span>Anket Kapandı</span>
                        }
                        else
                        {
                            <span>Oy Ver</span>
                        }
                    </button>
                </div>
            </form>
        </div>

        <!-- SAĞ: Canlı Sonuçlar -->
        <div class="bg-white dark:bg-card-dark rounded-2xl border border-gray-100 dark:border-white/10 shadow-sm p-6">
            <h2 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-5">Canlı Sonuçlar</h2>

            <div class="flex flex-col">
                <div class="flex items-end justify-between gap-4 h-[280px] border-b border-dashed border-gray-200 dark:border-white/10 pb-2">
                    @foreach (var secenek in orderedOptions)
                    {
                        int voteCount = secenek.Oys.Count;
                        double heightPercent = (winningOption != null && winningOption.Oys.Count > 0)
                        ? (((double)voteCount / winningOption.Oys.Count) * 100)
                        : (voteCount > 0 ? 100 : 0);

                        if (heightPercent == 0 && voteCount > 0) { heightPercent = 5; }

                        bool isWinner = (winningOption != null && secenek.SecenekId == winningOption.SecenekId && totalVotes > 0);

                        <div class="flex flex-col items-center justify-end w-full h-full gap-2 relative">
                            @if (isWinner)
                            {
                                <div class="absolute -top-10 flex flex-col items-center animate-bounce">
                                    <span class="material-symbols-outlined text-primary">emoji_events</span>
                                </div>
                            }

                            <div class="text-sm font-semibold text-gray-800 dark:text-white">@voteCount</div>

                            <div class="w-full rounded-t-lg transition-all duration-500 @(isWinner ? "bg-primary" : "bg-primary/30")"
                                 style="height:@heightPercent.ToString("F0")%;"></div>
                        </div>
                    }
                </div>

                <div class="flex justify-between gap-4 pt-3">
                    @foreach (var secenek in orderedOptions)
                    {
                        <p class="text-center text-xs text-gray-500 dark:text-gray-300 w-full truncate">
                            @secenek.SecenekText
                        </p>
                    }
                </div>

                <div class="mt-6 pt-5 border-t border-gray-100 dark:border-white/10 flex items-center justify-between text-sm">
                    <p class="text-gray-600 dark:text-gray-300">Toplam Oy:</p>
                    <p class="text-gray-900 dark:text-white font-bold text-lg">@totalVotes</p>
                </div>
            </div>
        </div>
    </div>

    @if (Model.IsActive)
    {
        <!-- Sticky sayaç (aynı özellik, uyumlu görünüm) -->
        <div class="sticky bottom-4 mt-10 z-10">
            <div class="rounded-2xl bg-gray-900 text-white px-5 py-4 shadow-[0_12px_30px_rgba(0,0,0,0.22)]">
                <div class="flex items-center justify-center gap-3">
                    <span class="material-symbols-outlined text-primary text-xl">timer</span>
                    <p class="font-semibold text-sm sm:text-base tracking-wide flex gap-2">
                        <span class="text-gray-300">Anketin bitmesine kalan süre:</span>
                        <span id="countdown" class="text-white">Hesaplanıyor...</span>
                    </p>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal (aynı özellik, sadece kart stili uyumlu) -->
<div id="infoModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
    <div class="bg-white dark:bg-card-dark rounded-2xl shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300 border border-gray-100 dark:border-white/10"
         id="modalContent">
        <div class="p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">info</span>
                    Etkinlik Detayları
                </h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-red-500 transition">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Seçenek Adı</p>
                    <p id="m-title" class="text-base text-gray-800 dark:text-gray-200 font-semibold"></p>
                </div>

                <div id="m-details-area" class="hidden space-y-3 bg-gray-50 dark:bg-black/20 p-4 rounded-xl border border-gray-100 dark:border-white/10">
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase">Kulüp:</span>
                        <span id="m-kulup" class="ml-2 text-gray-800 dark:text-white font-medium"></span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase">Başkan:</span>
                        <span id="m-baskan" class="ml-2 text-gray-800 dark:text-white font-medium"></span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase">Tarih:</span>
                        <span id="m-tarih" class="ml-2 text-primary font-bold"></span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase">Konum:</span>
                        <span id="m-konum" class="ml-2 text-gray-800 dark:text-white"></span>
                    </div>
                </div>

                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Açıklama</p>
                    <div id="m-desc" class="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/10"></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-black/20 px-6 py-4 rounded-b-2xl flex justify-end border-t border-gray-100 dark:border-white/10">
            <button id="closeModalBtn2"
                    class="px-4 py-2 bg-gray-200 dark:bg-white/10 text-gray-800 dark:text-white rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-white/20 transition">
                Tamam
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const infoButtons = document.querySelectorAll('.js-info-btn');

        infoButtons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();

                const title = this.getAttribute('data-title');
                const desc = this.getAttribute('data-desc');
                const kulup = this.getAttribute('data-kulup');
                const baskan = this.getAttribute('data-baskan');
                const tarih = this.getAttribute('data-tarih');
                const konum = this.getAttribute('data-konum');

                document.getElementById('m-title').innerText = title;
                document.getElementById('m-desc').innerText = desc || "Bu seçenek için ek açıklama girilmemiştir.";

                const detailsArea = document.getElementById('m-details-area');
                if (kulup && kulup.trim() !== "") {
                    detailsArea.classList.remove('hidden');
                    document.getElementById('m-kulup').innerText = kulup;
                    document.getElementById('m-baskan').innerText = baskan;
                    document.getElementById('m-tarih').innerText = tarih;
                    document.getElementById('m-konum').innerText = konum;
                } else {
                    detailsArea.classList.add('hidden');
                }

                showModal();
            });
        });

        document.getElementById('closeModalBtn').addEventListener('click', hideModal);
        document.getElementById('closeModalBtn2').addEventListener('click', hideModal);

        document.getElementById('infoModal').addEventListener('click', function (e) {
            if (e.target === this) hideModal();
        });
    });

    function showModal() {
        const modal = document.getElementById('infoModal');
        const content = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }, 10);
    }

    function hideModal() {
        const modal = document.getElementById('infoModal');
        const content = document.getElementById('modalContent');
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // Geri Sayım (aynı)
    var countDownDate = new Date("@Model.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")").getTime();
    var x = setInterval(function () {
        var el = document.getElementById("countdown");
        if (!el) return;

        var now = new Date().getTime();
        var distance = countDownDate - now;

        if (distance < 0) {
            clearInterval(x);
            el.innerHTML = "SÜRE DOLDU";
            return;
        }

        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

        el.innerHTML = days + "g " + hours + "s " + minutes + "d " + seconds + "sn ";
    }, 1000);
</script>
