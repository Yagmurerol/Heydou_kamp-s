@model hey.dou.Models.Anket
@{
    ViewData["Title"] = "Etkinlik Anketi";
    bool hasVoted = ViewBag.HasVoted ?? false;

    var orderedOptions = Model.AnketSecenegis.OrderBy(s => s.SecenekId).ToList();
    int totalVotes = orderedOptions.Sum(s => s.Oys.Count);
    var winningOption = (totalVotes > 0) ? orderedOptions.OrderByDescending(s => s.Oys.Count).FirstOrDefault() : null;
}

<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
    <div class="relative flex min-h-screen w-full flex-col">
        <main class="flex-grow">
            <div class="container mx-auto px-4 py-8 md:py-12 lg:px-8">

                <div class="mb-10 text-center relative">
                    <div class="flex items-center justify-center gap-3">
                        <h1 class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em]">
                            Etkinlik Anketi
                        </h1>
                    </div>
                    <p class="text-gray-500 dark:text-[#9db4b9] text-base font-normal leading-normal mt-2">
                        Aşağıdaki seçeneklerden birini oylayarak etkinliği belirleyin.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 xl:gap-12">

                    <div class="flex flex-col gap-6">
                        <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Oyunu Kullan</h2>

                        <form asp-action="Vote" method="post">
                            <input type="hidden" name="anketID" value="@Model.AnketId" />

                            <div class="flex flex-col gap-3">
                                @foreach (var secenek in orderedOptions)
                                {
                                    <div class="relative group">
                                        <label class="flex items-center gap-4 rounded-lg border border-solid border-gray-200 dark:border-[#3b4f54] p-4 cursor-pointer hover:border-primary/50 transition-colors has-[:checked]:border-primary has-[:checked]:bg-primary/10 dark:has-[:checked]:bg-primary/20">

                                            <input class="h-5 w-5 border-2 border-gray-300 dark:border-[#3b4f54] bg-transparent text-primary focus:ring-primary checked:border-primary checked:bg-primary"
                                                   name="secenekID" value="@secenek.SecenekId" type="radio" required disabled="@(hasVoted || !Model.IsActive)" />

                                            <div class="flex grow items-center justify-between">
                                                <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">
                                                    @secenek.SecenekText
                                                </p>

                                                <button type="button"
                                                        class="js-info-btn text-gray-400 hover:text-primary transition-colors p-1 rounded-full hover:bg-primary/10"
                                                        data-title="@secenek.SecenekText"
                                                        data-desc="@secenek.KisaAciklama"
                                                        data-kulup="@secenek.KulupAdi"
                                                        data-baskan="@secenek.KulupBaskaniAdi"
                                                        data-konum="@secenek.Konum"
                                                        data-tarih="@(secenek.TarihSaat.HasValue? secenek.TarihSaat.Value.ToString("dd MMMM HH:mm") : "")">
                                                    <span class="material-symbols-outlined text-2xl">info</span>
                                                </button>
                                            </div>
                                        </label>
                                    </div>
                                }
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="flex min-w-[84px] w-full max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal hover:bg-opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled="@(hasVoted || !Model.IsActive)">
                                    @if (hasVoted)
                                    {
                                        <span>Oy Verdiniz</span>
                                    }
                                    else if (!Model.IsActive)
                                    {

                                        <span>Anket Kapandı</span>
                                    }
                                    else
                                    {

                                        <span>Oy Ver</span>
                                    }
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="bg-white/50 dark:bg-black/20 rounded-xl p-6 h-full flex flex-col">
                            <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em] mb-6">Canlı Sonuçlar</h2>
                            <div class="flex flex-col flex-grow">
                                <div class="flex items-end justify-between gap-4 h-[300px] border-b border-dashed border-gray-300 dark:border-white/20 pb-2">
                                    @foreach (var secenek in orderedOptions)
                                    {
                                        int voteCount = secenek.Oys.Count;
                                        double heightPercent = (winningOption != null && winningOption.Oys.Count > 0) ? (((double)voteCount / winningOption.Oys.Count) * 100) : (voteCount > 0 ? 100 : 0);
                                        if (heightPercent == 0 && voteCount > 0) { heightPercent = 5; }
                                        bool isWinner = (winningOption != null && secenek.SecenekId == winningOption.SecenekId && totalVotes > 0);

                                        <div class="flex flex-col items-center justify-end w-full h-full gap-2 relative">
                                            @if (isWinner)
                                            {
                                                <div class="absolute -top-10 flex flex-col items-center animate-bounce">
                                                    <span class="material-symbols-outlined text-primary">emoji_events</span>
                                                </div>
                                            }
                                            <div class="text-sm font-semibold text-gray-800 dark:text-white">@voteCount</div>
                                            <div class="w-full @(isWinner ? "bg-primary" : "bg-primary/30") rounded-t-md transition-all duration-500"
                                                 style="height: @heightPercent.ToString("F0")%;"></div>
                                        </div>
                                    }
                                </div>
                                <div class="flex justify-between gap-4 pt-2">
                                    @foreach (var secenek in orderedOptions)
                                    {
                                        <p class="text-center text-xs text-gray-500 dark:text-[#9db4b9] w-full truncate">@secenek.SecenekText</p>
                                    }
                                </div>
                                <div class="mt-auto pt-6 border-t border-gray-200 dark:border-white/10 flex items-center justify-between text-sm">
                                    <p class="text-gray-600 dark:text-[#9db4b9]">Toplam Oy:</p>
                                    <p class="text-gray-900 dark:text-white font-bold text-lg">@totalVotes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        @if (Model.IsActive)
        {
            <footer class="sticky bottom-0 z-10 w-full mt-12">
                <div class="bg-background-dark text-white py-3 px-4 shadow-[0_-4px_10px_rgba(0,0,0,0.1)]">
                    <div class="container mx-auto flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined text-primary text-xl">timer</span>
                        <p class="font-semibold text-base tracking-wide flex gap-2">
                            <span class="text-gray-400">Anketin bitmesine kalan süre:</span>
                            <span id="countdown" class="text-white">Hesaplanıyor...</span>
                        </p>
                    </div>
                </div>
            </footer>
        }
    </div>

    <div id="infoModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-[#1a2835] rounded-2xl shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300" id="modalContent">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">info</span>
                        Etkinlik Detayları
                    </h3>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Seçenek Adı</p>
                        <p id="m-title" class="text-lg text-gray-800 dark:text-gray-200 font-medium"></p>
                    </div>

                    <div id="m-details-area" class="hidden space-y-3 bg-gray-50 dark:bg-black/20 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Kulüp:</span>
                            <span id="m-kulup" class="ml-2 text-gray-800 dark:text-white font-medium"></span>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Başkan:</span>
                            <span id="m-baskan" class="ml-2 text-gray-800 dark:text-white font-medium"></span>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Tarih:</span>
                            <span id="m-tarih" class="ml-2 text-primary font-bold"></span>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Konum:</span>
                            <span id="m-konum" class="ml-2 text-gray-800 dark:text-white"></span>
                        </div>
                    </div>

                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Açıklama</p>
                        <div id="m-desc" class="text-base text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-black/20 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-black/20 px-6 py-4 rounded-b-2xl flex justify-end">
                <button id="closeModalBtn2" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg font-medium hover:bg-gray-300 transition-colors">
                    Tamam
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sayfa yüklendiğinde olay dinleyicilerini (Event Listeners) ekle
        document.addEventListener('DOMContentLoaded', function() {

            // Tüm bilgi butonlarını bul
            const infoButtons = document.querySelectorAll('.js-info-btn');

            // Hepsine tıklama olayı ekle
            infoButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); // Sayfa yenilenmesini engelle

                    // Verileri butondan al
                    const title = this.getAttribute('data-title');
                    const desc = this.getAttribute('data-desc');
                    const kulup = this.getAttribute('data-kulup');
                    const baskan = this.getAttribute('data-baskan');
                    const tarih = this.getAttribute('data-tarih');
                    const konum = this.getAttribute('data-konum');

                    // Modalı doldur
                    document.getElementById('m-title').innerText = title;
                    document.getElementById('m-desc').innerText = desc || "Bu seçenek için ek açıklama girilmemiştir.";

                    const detailsArea = document.getElementById('m-details-area');
                    if (kulup && kulup.trim() !== "") {
                        detailsArea.classList.remove('hidden');
                        document.getElementById('m-kulup').innerText = kulup;
                        document.getElementById('m-baskan').innerText = baskan;
                        document.getElementById('m-tarih').innerText = tarih;
                        document.getElementById('m-konum').innerText = konum;
                    } else {
                        detailsArea.classList.add('hidden');
                    }

                    // Modalı göster
                    showModal();
                });
            });

            // Kapatma butonlarına olay ekle
            document.getElementById('closeModalBtn').addEventListener('click', hideModal);
            document.getElementById('closeModalBtn2').addEventListener('click', hideModal);

            // Dışarı tıklayınca kapat
            document.getElementById('infoModal').addEventListener('click', function(e) {
                if (e.target === this) hideModal();
            });
        });

        function showModal() {
            const modal = document.getElementById('infoModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function hideModal() {
            const modal = document.getElementById('infoModal');
            const content = document.getElementById('modalContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Geri Sayım
        var countDownDate = new Date("@Model.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")").getTime();
        var x = setInterval(function() {
            var now = new Date().getTime();
            var distance = countDownDate - now;
            if (distance < 0) {
                clearInterval(x);
                document.getElementById("countdown").innerHTML = "SÜRE DOLDU";
                return;
            }
            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById("countdown").innerHTML = days + "g " + hours + "s " + minutes + "d " + seconds + "sn ";
        }, 1000);
    </script>
</body>