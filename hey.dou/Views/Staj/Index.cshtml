@{
    ViewData["Title"] = "Staj İlanları";
}

<div class="flex flex-wrap justify-between gap-4 py-4 items-end">
    <div class="flex min-w-72 flex-col gap-2">
        <h1 class="text-slate-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">
            Staj Fırsatlarını Keşfet
        </h1>
        <p class="text-slate-500 dark:text-slate-400 text-lg font-normal leading-normal">
            Kariyerine yön verecek staj ilanlarını burada bulabilirsin.
        </p>
    </div>

    <div id="ilanCount" class="flex items-end text-sm font-medium text-primary bg-primary/10 px-3 py-1 rounded-lg"></div>
</div>

<div class="flex flex-col lg:flex-row gap-8">
    <aside class="w-full lg:w-72 lg:shrink-0">
        <div class="lg:sticky lg:top-24 flex flex-col gap-6 p-6 bg-white dark:bg-card-dark rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-rounded text-primary">filter_list</span>
                Ara &amp; Filtrele
            </h3>

            <div class="flex flex-col gap-2">
                <label for="search" class="text-sm font-medium text-slate-700 dark:text-slate-300">Anahtar Kelime</label>
                <div class="relative">
                    <span class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                    <input id="search"
                           class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-sm"
                           placeholder="Pozisyon, şirket..." />
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label for="sort" class="text-sm font-medium text-slate-700 dark:text-slate-300">Sırala</label>
                <div class="relative">
                    <span class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">sort</span>
                    <select id="sort"
                            class="w-full pl-10 pr-8 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/50 text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent appearance-none cursor-pointer">
                        <option>Yayınlanma Tarihi (En Yeni)</option>
                        <option>Son Başvuru Tarihi Yaklaşanlar</option>
                    </select>
                    <span class="material-symbols-rounded absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">expand_more</span>
                </div>
            </div>

            <button id="filterButton"
                    class="w-full flex items-center justify-center gap-2 rounded-xl h-11 bg-primary hover:bg-primary-dark text-white text-sm font-bold transition-all transform active:scale-95 shadow-lg shadow-primary/30">
                Filtrele
            </button>
        </div>
    </aside>

    <div class="flex-1">
        <div id="stajGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div id="stajMessage" class="mt-12 flex flex-col items-center justify-center text-center text-slate-400"></div>
    </div>
</div>

@section Scripts {
    <script>
        const apiUrl = "/api/Staj/Listele";

        const gridEl = document.getElementById("stajGrid");
        const messageEl = document.getElementById("stajMessage");
        const searchInput = document.getElementById("search");
        const sortSelect = document.getElementById("sort");
        const filterButton = document.getElementById("filterButton");
        const ilanCountEl = document.getElementById("ilanCount");

        let allStajlar = [];

        function formatTarih(dateStr) {
            if (!dateStr) return "Belirtilmemiş";
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString("tr-TR", { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function getSirketIlkHarf(sirket) {
            if (!sirket) return "?";
            return sirket.trim().charAt(0).toUpperCase();
        }

        function renderStajlar() {
            const searchValue = (searchInput.value || "").toLowerCase();
            const sortValue = sortSelect.value;

            let list = [...allStajlar];

            if (searchValue) {
                list = list.filter(i =>
                    (i.baslik || i.Baslik || "").toLowerCase().includes(searchValue) ||
                    (i.sirket || i.Sirket || "").toLowerCase().includes(searchValue)
                );
            }

            const getDate = (item, fieldCamel, fieldPascal) => {
                const val = item[fieldCamel] || item[fieldPascal];
                return val ? new Date(val) : null;
            };

            if (sortValue.includes("Son Başvuru")) {
                list.sort((a, b) => {
                    const da = getDate(a, "sonBasvuru", "SonBasvuru");
                    const db = getDate(b, "sonBasvuru", "SonBasvuru");
                    if (!da && !db) return 0;
                    if (!da) return 1;
                    if (!db) return -1;
                    return da - db;
                });
            } else {
                list.sort((a, b) => {
                    const da = getDate(a, "yayinlanmaTarihi", "YayinlanmaTarihi");
                    const db = getDate(b, "yayinlanmaTarihi", "YayinlanmaTarihi");
                    if (!da && !db) return 0;
                    if (!da) return 1;
                    if (!db) return -1;
                    return db - da;
                });
            }

            ilanCountEl.innerHTML = list.length
                ? `<span class="font-bold mr-1">${list.length}</span> ilan listeleniyor`
                : "";

            if (!list.length) {
                gridEl.innerHTML = "";
                messageEl.innerHTML = `
                    <span class="material-symbols-rounded text-6xl mb-4 opacity-20">search_off</span>
                    <p class="text-lg">Aradığınız kriterlere uygun ilan bulunamadı.</p>
                `;
                return;
            }

            messageEl.innerHTML = "";

            gridEl.innerHTML = list.map(item => {
                const baslik = item.baslik || item.Baslik || "";
                const sirket = item.sirket || item.Sirket || "";
                const lokasyon = item.lokasyon || item.Lokasyon || "";
                const stajTuru = item.stajTuru || item.StajTuru || "";
                const aciklama = item.aciklama || item.Aciklama || "";
                const yayinlanma = formatTarih(item.yayinlanmaTarihi || item.YayinlanmaTarihi);
                const sonBasvuru = formatTarih(item.sonBasvuru || item.SonBasvuru);
                const basvuruLinki = item.basvuruLinki || item.BasvuruLinki || "#";

                const ilkHarf = getSirketIlkHarf(sirket);

                const bgColors = ["bg-orange-100 text-orange-600", "bg-blue-100 text-blue-600", "bg-purple-100 text-purple-600", "bg-green-100 text-green-600"];
                const randomBg = bgColors[Math.floor(Math.random() * bgColors.length)];

                return `
                <div class="group flex flex-col justify-between p-6 rounded-2xl bg-white dark:bg-card-dark border border-slate-100 dark:border-slate-700/50 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div>
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl ${randomBg} flex items-center justify-center shrink-0 shadow-inner">
                                    <span class="text-xl font-black">${ilkHarf}</span>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-slate-900 dark:text-white leading-tight group-hover:text-primary transition-colors line-clamp-1">${baslik}</h4>
                                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">${sirket}</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-slate-50 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300 text-xs font-semibold border border-slate-100 dark:border-slate-600">
                                <span class="material-symbols-rounded !text-sm">location_on</span> ${lokasyon}
                            </span>
                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 text-xs font-semibold border border-green-100 dark:border-green-800/30">
                                <span class="material-symbols-rounded !text-sm">work</span> ${stajTuru}
                            </span>
                        </div>

                        ${aciklama ? `<p class="text-sm text-slate-600 dark:text-slate-300 mb-4 line-clamp-2">${aciklama}</p>` : ""}

                        <div class="flex items-center justify-between text-xs text-slate-400 mb-6 pt-4 border-t border-slate-50 dark:border-slate-700/50">
                            <span class="flex items-center gap-1"><span class="material-symbols-rounded !text-sm">schedule</span> ${yayinlanma}</span>
                            <span class="flex items-center gap-1 text-primary"><span class="material-symbols-rounded !text-sm">event_busy</span> Son: ${sonBasvuru}</span>
                        </div>
                    </div>

                    <a href="${basvuruLinki}" target="_blank" rel="noopener noreferrer"
                       class="w-full flex items-center justify-center gap-2 rounded-xl py-3 text-sm font-bold bg-slate-900 dark:bg-slate-700 hover:bg-primary text-white transition-all group-hover:shadow-lg group-hover:shadow-primary/20">
                        Başvuru Yap
                        <span class="material-symbols-rounded !text-lg">open_in_new</span>
                    </a>
                </div>`;
            }).join("");
        }

        async function loadStajlar() {
            messageEl.innerHTML = `
                <span class="material-symbols-rounded text-4xl animate-spin text-primary mb-2">progress_activity</span>
                <p>İlanlar yükleniyor...</p>
            `;
            gridEl.innerHTML = "";

            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error("İlanlar yüklenemedi");

                const data = await res.json();

                if (!data.success) {
                    messageEl.textContent = "İlanlar yüklenirken bir hata oluştu.";
                    return;
                }

                allStajlar = data.stajlar || data.Stajlar || [];
                if (!allStajlar.length) {
                    messageEl.innerHTML = `
                        <span class="material-symbols-rounded text-6xl mb-4 opacity-20">inbox</span>
                        <p class="text-lg">Şu anda aktif staj ilanı bulunmamaktadır.</p>
                    `;
                    return;
                }

                messageEl.innerHTML = "";
                renderStajlar();
            } catch (err) {
                console.error(err);
                messageEl.innerHTML = `
                    <span class="material-symbols-rounded text-6xl mb-4 text-red-400 opacity-50">error</span>
                    <p class="text-lg text-red-500">Sunucuyla bağlantı kurulamadı.</p>
                `;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadStajlar();
            filterButton.addEventListener("click", renderStajlar);
            searchInput.addEventListener("keyup", (e) => { if (e.key === "Enter") renderStajlar(); });
            sortSelect.addEventListener("change", renderStajlar);
        });
    </script>
}
